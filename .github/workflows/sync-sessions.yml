# ============================================================================
# üîÑ Sync sessions + root README from private repos-teachers ‚Üí repos-students
#    (via Deploy Key)
#
# Objectiu:
# - Des d‚Äôun repo privat de profes (source) copia:
#   - README.md de l‚Äôarrel (opcional)
#   - Per a cada carpeta 'sessionNN' oberta, el README.md i la subcarpeta 'starter/'
# - Les sessions ‚Äúobertes‚Äù venen definides al fitxer configurat per la variable
#   OPEN_SESSIONS_FILE (p. ex. ".course/open-sessions.txt").
# ============================================================================

name: üîÑ Sync sessions + root README from private repos-teachers ‚Üí repos-students (Deploy Key)

# ----------------------------------------------------------------------------
# üïê Triggers del workflow
# ----------------------------------------------------------------------------
on:
  schedule:
    - cron: '0 * * * *' # cada hora
  workflow_dispatch: {}

# ----------------------------------------------------------------------------
# üîí Permisos necessaris
# ----------------------------------------------------------------------------
permissions:
  contents: write # permet fer commit i push al repo dest√≠

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# üîß VARIABLES CONFIGURABLES
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
env:
  # --- Source (repo de profes, privat) --------------------------------------
  SOURCE_ORG: 'LSG-markup-lang' # Organitzaci√≥ d‚Äôorigen
  SOURCE_REPO: 'demos' # Nom del repo d‚Äôorigen
  SOURCE_BRANCH: 'main' # Branca d‚Äôorigen

  # --- Auth (Deploy Key via secret) -----------------------------------------
  SOURCE_DEPLOY_KEY_SECRET: 'SOURCE_DEPLOY_KEY'

  # --- Target (repo d‚Äôalumnes; normalment aquest) ---------------------------
  TARGET_BRANCH: 'main'

  # --- Qu√® copiar del source ------------------------------------------------
  COPY_ROOT_README: 'true' # "true" o "false" per copiar README.md arrel
  SESSION_PATTERN: 'session[0-9][0-9]' # Patr√≥ de carpetes de sessi√≥
  STARTER_DIRNAME: 'starter' # Nom de la subcarpeta dins de cada sessi√≥

  # --- Fitxer amb la llista de sessions obertes -----------------------------
  OPEN_SESSIONS_FILE: '_course/open-sessions.txt'

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------------
      # ‚¨áÔ∏è 1) Checkout del repo dest√≠
      # ----------------------------------------------------------------------
      - name: ‚¨áÔ∏è Checkout target (${{ github.repository }} @ ${{ env.TARGET_BRANCH }})
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.TARGET_BRANCH }}

      # ----------------------------------------------------------------------
      # üîê 2) Configuraci√≥ SSH per accedir al repo privat d‚Äôorigen (Deploy Key)
      # ----------------------------------------------------------------------
      - name: üîê Setup SSH for private source (Deploy Key)
        env:
          SOURCE_DEPLOY_KEY: ${{ secrets[env.SOURCE_DEPLOY_KEY_SECRET] }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "$SOURCE_DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # ----------------------------------------------------------------------
      # ‚¨áÔ∏è 3) Clonaci√≥ del repo d‚Äôorigen (privat) a ./source
      # ----------------------------------------------------------------------
      - name: ‚¨áÔ∏è Clone private source repo (${{ env.SOURCE_ORG }}/${{ env.SOURCE_REPO }} @ ${{ env.SOURCE_BRANCH }})
        run: |
          set -euo pipefail
          git clone --depth=1 --branch "${SOURCE_BRANCH}" "git@github.com:${SOURCE_ORG}/${SOURCE_REPO}.git" source

      # ----------------------------------------------------------------------
      # üö¶ 4) Filtrat de sessions segons $OPEN_SESSIONS_FILE
      # ----------------------------------------------------------------------
      - name: üö¶ Filter source sessions by ${{ env.OPEN_SESSIONS_FILE }}
        shell: bash
        run: |
          set -euo pipefail

          OPEN_FILE="${OPEN_SESSIONS_FILE}"

          # 1) Llegeix la llista de sessions obertes (si el fitxer existeix)
          if [[ -f "$OPEN_FILE" ]]; then
            mapfile -t OPEN_SESS < <(grep -E '^[[:space:]]*session[0-9][0-9][[:space:]]*$' "$OPEN_FILE" \
                                      | tr -d ' ' \
                                      | sort -u)
          else
            echo "‚ö†Ô∏è No s'ha trobat $OPEN_FILE ‚Üí no s'obrir√† cap sessi√≥."
            OPEN_SESS=()
          fi

          # 2) Llista de sessions existents al repo font
          cd source
          mapfile -t SRC_SESS < <(find . -maxdepth 1 -mindepth 1 -type d -name "${SESSION_PATTERN}" -printf '%f\n' 2>/dev/null | sort -u || true)
          cd ..

          # 3) Funci√≥ helper per saber si una sessi√≥ est√† oberta
          is_open() {
            local x="$1"
            for s in "${OPEN_SESS[@]:-}"; do
              [[ "$s" == "$x" ]] && return 0
            done
            return 1
          }

          # 4) Elimina del clon totes les sessions tancades
          KEPT=0
          REMOVED=0
          for d in "${SRC_SESS[@]:-}"; do
            if is_open "$d"; then
              echo "‚úÖ Keep $d"
              KEPT=$((KEPT+1))
            else
              echo "üßπ Remove (closed) $d"
              rm -rf "source/$d"
              REMOVED=$((REMOVED+1))
            fi
          done

          echo "Summary: kept=$KEPT removed=$REMOVED"

      # ----------------------------------------------------------------------
      # üîé 5) Detecci√≥ de sessions a sincronitzar
      # ----------------------------------------------------------------------
      - name: üîé Detect sessions to sync
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          SESS="$(cd source && find . -maxdepth 1 -type d -name "${SESSION_PATTERN}" -printf '%f ' 2>/dev/null || true)"
          echo "sessions=${SESS:-}" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------------------------
      # üß© 6) C√≤pia de sessions i README.md arrel
      # ----------------------------------------------------------------------
      - name: üß© Copy sessions and root README.md
        if: ${{ steps.pick.outputs.sessions != '' }}
        shell: bash
        run: |
          set -euo pipefail

          # Copia del README.md arrel (si est√† activat)
          if [[ "${COPY_ROOT_README}" == "true" && -f "source/README.md" ]]; then
            echo "‚Üí Syncing root README.md"
            cp -f "source/README.md" README.md
          fi

          # Recorre les sessions detectades
          for S in ${{ steps.pick.outputs.sessions }}; do
            [[ -d "source/$S" ]] || continue
            echo "‚Üí Sync $S"

            mkdir -p "$S"

            # Copia README.md de la sessi√≥
            if [[ -f "source/$S/README.md" ]]; then
              cp -f "source/$S/README.md" "$S/README.md"
            fi

            # Copia starter/ (destructiu per mantenir-lo sincronitzat 1:1)
            if [[ -d "source/$S/${STARTER_DIRNAME}" ]]; then
              rm -rf "$S/${STARTER_DIRNAME}"
              rsync -a --delete "source/$S/${STARTER_DIRNAME}/" "$S/${STARTER_DIRNAME}/"
            fi
          done

      # ----------------------------------------------------------------------
      # ‚úÖ 7) Commit & push dels canvis (si n‚Äôhi ha)
      # ----------------------------------------------------------------------
      - name: ‚úÖ Commit & push changes (if any)
        env:
          COMMIT_SESSIONS: ${{ steps.pick.outputs.sessions }}
        run: |
          set -euo pipefail
          rm -rf source

          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(sync): update root README and ${COMMIT_SESSIONS} from ${SOURCE_ORG}/${SOURCE_REPO} [skip ci]"
            git push origin "HEAD:${TARGET_BRANCH}"
          else
            echo "‚úÖ No changes."
          fi
