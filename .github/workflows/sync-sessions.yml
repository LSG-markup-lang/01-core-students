# ============================================================================
# üîÑ Sync sessions + root README from private repos-teachers ‚Üí repos-students
#    (via Deploy Key)
#
# Objectiu:
# - Des d‚Äôun repo privat de profes (source) copia:
#   - README.md de l‚Äôarrel (opcional)
#   - Per a cada carpeta 'sessionNN' oberta, el README.md i la subcarpeta 'starter/'
# - Les sessions ‚Äúobertes‚Äù venen definides al fitxer configurat per la variable
#   OPEN_SESSIONS_FILE (p. ex. ".course/open-sessions.txt").
# ============================================================================

name: üîÑ Sync sessions + root README from private repos-teachers ‚Üí repos-students (Deploy Key)

# ----------------------------------------------------------------------------
# üïê Triggers del workflow
# ----------------------------------------------------------------------------
on:
  schedule:
    - cron: '0 * * * *' # cada hora
  workflow_dispatch: {}

# ----------------------------------------------------------------------------
# üîí Permisos necessaris
# ----------------------------------------------------------------------------
permissions:
  contents: write # permet fer commit i push al repo dest√≠

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# üîß VARIABLES CONFIGURABLES
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
env:
  # --- Source (repo de profes, privat) --------------------------------------
  SOURCE_ORG: 'LSG-markup-lang' # Organitzaci√≥ d‚Äôorigen
  SOURCE_REPO: 'demos-teachers'          # Nom del repo d‚Äôorigen
  SOURCE_BRANCH: 'main'         # Branca d‚Äôorigen

  # --- Auth (Deploy Key via secret) -----------------------------------------
  SOURCE_DEPLOY_KEY_SECRET: 'SOURCE_DEPLOY_KEY'

  # --- Target (repo d‚Äôalumnes; normalment aquest) ---------------------------
  TARGET_BRANCH: 'main'

  # --- Qu√® copiar del source ------------------------------------------------
  COPY_ROOT_README: 'true'         # "true" o "false" per copiar README.md arrel
  SESSION_PATTERN: 'session[0-9][0-9]' # Patr√≥ de carpetes de sessi√≥
  STARTER_DIRNAME: 'starter'       # Nom de la subcarpeta dins de cada sessi√≥

  # --- Fitxer amb la llista de sessions obertes -----------------------------
  OPEN_SESSIONS_FILE: '_course/open-sessions.txt'

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------------
      # ‚¨áÔ∏è 1) Checkout del repo dest√≠
      # ----------------------------------------------------------------------
      - name: ‚¨áÔ∏è Checkout target (${{ github.repository }} @ ${{ env.TARGET_BRANCH }})
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.TARGET_BRANCH }}

      # ----------------------------------------------------------------------
      # üîê 2) Configuraci√≥ SSH per accedir al repo privat d‚Äôorigen (Deploy Key)
      # ----------------------------------------------------------------------
      - name: üîê Setup SSH for private source (Deploy Key)
        env:
          SOURCE_DEPLOY_KEY: ${{ secrets[env.SOURCE_DEPLOY_KEY_SECRET] }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "$SOURCE_DEPLOY_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # ----------------------------------------------------------------------
      # ‚¨áÔ∏è 3) Clonaci√≥ del repo d‚Äôorigen (privat) a ./source
      # ----------------------------------------------------------------------
      - name: ‚¨áÔ∏è Clone private source repo (${{ env.SOURCE_ORG }}/${{ env.SOURCE_REPO }} @ ${{ env.SOURCE_BRANCH }})
        run: |
          set -euo pipefail
          git clone --depth=1 --branch "${SOURCE_BRANCH}" "git@github.com:${SOURCE_ORG}/${SOURCE_REPO}.git" source

      # ----------------------------------------------------------------------
      # üö¶ 4) Calcula sessions a sincronitzar (intersecci√≥ OPEN √ó SOURCE)
      #     (No esborra res a "source/"; nom√©s construeix l'allowlist)
      # ----------------------------------------------------------------------
      - name: üö¶ Build allowlist from ${{ env.OPEN_SESSIONS_FILE }} ‚à© source
        id: allow
        shell: bash
        run: |
          set -euo pipefail

          OPEN_FILE="${OPEN_SESSIONS_FILE}"

          # 1) Llegeix sessions obertes tolerant comentaris/espais/CRLF
          if [[ -f "$OPEN_FILE" ]]; then
            mapfile -t OPEN_SESS < <(
              sed -E 's/#.*$//' "$OPEN_FILE" |  # treu comentaris
              tr -d '\r' |                      # treu CR (Windows)
              grep -Eo 'session[0-9]{2}' || true
            )
          else
            echo "‚ö†Ô∏è No s'ha trobat $OPEN_FILE ‚Üí cap sessi√≥ oberta."
            OPEN_SESS=()
          fi

          # Normalitza i treu duplicats
          if (( ${#OPEN_SESS[@]} > 0 )); then
            mapfile -t OPEN_SESS < <(printf "%s\n" "${OPEN_SESS[@]}" | sort -u)
          fi
          echo "OPEN_SESS: ${OPEN_SESS[*]:-‚àÖ}"

          # 2) Llista de sessions existents al repo font
          mapfile -t SRC_SESS < <(cd source && find . -maxdepth 1 -mindepth 1 -type d -name "${SESSION_PATTERN}" -printf '%f\n' 2>/dev/null | sort -u || true)
          echo "SRC_SESS:  ${SRC_SESS[*]:-‚àÖ}"

          # 3) Intersecci√≥: nom√©s les que s√≥n a OPEN i existeixen a source
          declare -A SEEN=()
          for s in "${SRC_SESS[@]:-}"; do SEEN["$s"]=1; done

          ALLOW=()
          for s in "${OPEN_SESS[@]:-}"; do
            if [[ -n "${SEEN[$s]:-}" ]]; then
              ALLOW+=("$s")
            else
              echo "‚ÑπÔ∏è  Ometo ${s}: no existeix al repo font."
            fi
          done

          # 4) Exporta la llista (separada per espais) com a output
          if (( ${#ALLOW[@]} > 0 )); then
            SESSIONS="$(printf "%s " "${ALLOW[@]}")"
            echo "allow_sessions=${SESSIONS}" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Sessions a sync: ${SESSIONS}"
          else
            echo "allow_sessions=" >> "$GITHUB_OUTPUT"
            echo "‚úÖ No hi ha sessions per sincronitzar."
          fi

      # ----------------------------------------------------------------------
      # üîé 5) Detecci√≥ de sessions a sincronitzar (des de l'allowlist)
      # ----------------------------------------------------------------------
      - name: üîé Detect sessions to sync
        id: pick
        shell: bash
        run: |
          set -euo pipefail
          echo "sessions=${{ steps.allow.outputs.allow_sessions }}" >> "$GITHUB_OUTPUT"

      # ----------------------------------------------------------------------
      # üßπ 6) (OPCI√ì B) Purge al repo d'alumnes:
      #        esborra del target totes les sessions que NO estiguin obertes
      # ----------------------------------------------------------------------
      - name: üßπ Purge closed sessions from target
        shell: bash
        run: |
          set -euo pipefail

          # Construeix un set amb les obertes
          declare -A ALLOWED=()
          for s in ${{ steps.pick.outputs.sessions }}; do
            [[ -n "$s" ]] && ALLOWED["$s"]=1
          done

          # Cerca carpetes de sessi√≥ al directori arrel del repo d'alumnes
          mapfile -t EXIST < <(find . -maxdepth 1 -mindepth 1 -type d -name "${SESSION_PATTERN}" -printf '%f\n' 2>/dev/null | sort -u || true)

          REMOVED=0
          KEPT=0
          for d in "${EXIST[@]:-}"; do
            if [[ -z "${ALLOWED[$d]:-}" ]]; then
              echo "üßπ Remove closed session $d"
              rm -rf "$d"
              REMOVED=$((REMOVED+1))
            else
              echo "‚úÖ Keep open session $d"
              KEPT=$((KEPT+1))
            fi
          done

          echo "Summary purge: kept=$KEPT removed=$REMOVED"

      # ----------------------------------------------------------------------
      # üß© 7) C√≤pia de sessions i README.md arrel
      # ----------------------------------------------------------------------
      - name: üß© Copy sessions and root README.md
        if: ${{ steps.pick.outputs.sessions != '' }}
        shell: bash
        run: |
          set -euo pipefail

          # Copia del README.md arrel (si est√† activat i existeix al source)
          if [[ "${COPY_ROOT_README}" == "true" && -f "source/README.md" ]]; then
            echo "‚Üí Syncing root README.md"
            cp -f "source/README.md" README.md
          fi

          # Recorre les sessions de l'allowlist
          for S in ${{ steps.pick.outputs.sessions }}; do
            [[ -d "source/$S" ]] || continue
            echo "‚Üí Sync $S"

            mkdir -p "$S"

            # Copia README.md de la sessi√≥ (si existeix)
            if [[ -f "source/$S/README.md" ]]; then
              cp -f "source/$S/README.md" "$S/README.md"
            fi

            # Copia starter/ (destructiu per mantenir-lo sincronitzat 1:1)
            if [[ -d "source/$S/${STARTER_DIRNAME}" ]]; then
              rm -rf "$S/${STARTER_DIRNAME}"
              rsync -a --delete "source/$S/${STARTER_DIRNAME}/" "$S/${STARTER_DIRNAME}/"
            fi
          done

      # ----------------------------------------------------------------------
      # ‚úÖ 8) Commit & push dels canvis (si n‚Äôhi ha)
      # ----------------------------------------------------------------------
      - name: ‚úÖ Commit & push changes (if any)
        env:
          COMMIT_SESSIONS: ${{ steps.pick.outputs.sessions }}
        run: |
          set -euo pipefail
          rm -rf source

          if [ -n "$(git status --porcelain)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(sync): purge closed + update root README and ${COMMIT_SESSIONS} from ${SOURCE_ORG}/${SOURCE_REPO} [skip ci]"
            git push origin "HEAD:${TARGET_BRANCH}"
          else
            echo "‚úÖ No changes."
          fi
